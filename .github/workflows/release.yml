name: Build & Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pages: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: nihongo-linux
            binary: dist/nihongo
          - os: macos-latest
            artifact: nihongo-macos
            binary: dist/nihongo
          - os: windows-latest
            artifact: nihongo-windows.exe
            binary: dist/nihongo.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install rich>=13.0 pyinstaller

      - name: Build binary
        run: python -m PyInstaller nihongo.spec --clean --noconfirm

      - name: Test binary
        shell: bash
        continue-on-error: ${{ matrix.os == 'windows-latest' }}
        run: ./${{ matrix.binary }} --version

      - name: Rename artifact
        if: always()
        shell: bash
        run: cp "${{ matrix.binary }}" "${{ matrix.artifact }}"

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  # --- Windows Installer (Inno Setup) ---
  windows-installer:
    needs: [build]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: nihongo-windows.exe
          path: .

      - name: Build installer
        shell: pwsh
        run: |
          $ver = "${{ github.ref_name }}".TrimStart("v")
          iscc "/DMyAppVersion=$ver" installer.iss

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: nihongo-setup
          path: Output/nihongo-setup-*.exe

  # --- macOS PKG Installer ---
  macos-pkg:
    needs: [build]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS binary
        uses: actions/download-artifact@v4
        with:
          name: nihongo-macos
          path: .

      - name: Create PKG installer
        run: |
          VER="${GITHUB_REF_NAME#v}"
          chmod +x nihongo-macos

          # Gatekeeper quarantine kaldır
          xattr -cr nihongo-macos

          # Paket içeriğini hazırla
          mkdir -p pkg-root/usr/local/bin
          cp nihongo-macos pkg-root/usr/local/bin/nihongo

          # Post-install script: edge-tts + mpv kur, audio pack indir
          mkdir -p scripts
          cat > scripts/postinstall <<'POSTINST'
          #!/bin/bash
          # edge-tts ve mpv kur (Homebrew varsa)
          if command -v brew &>/dev/null; then
            brew install mpv 2>/dev/null || true
          fi
          if command -v pipx &>/dev/null; then
            pipx install edge-tts 2>/dev/null || true
          elif command -v pip3 &>/dev/null; then
            pip3 install --user edge-tts 2>/dev/null || true
          fi
          # Quarantine flag kaldır
          xattr -cr /usr/local/bin/nihongo 2>/dev/null || true
          chmod +x /usr/local/bin/nihongo
          # Audio pack indir (kullanıcının home dizinine)
          REAL_HOME=$(eval echo ~"$USER")
          CACHE_DIR="${REAL_HOME}/Library/Application Support/nihongo/tts_cache"
          mkdir -p "${CACHE_DIR}"
          ZIP="/tmp/nihongo_tts_cache.zip"
          curl -fsSL -o "${ZIP}" "https://github.com/rapoyrazoglu/nihongo/releases/latest/download/tts_cache.zip" 2>/dev/null && \
            unzip -o -q "${ZIP}" -d "${CACHE_DIR}" 2>/dev/null && \
            rm -f "${ZIP}" || true
          exit 0
          POSTINST
          chmod +x scripts/postinstall

          # Component pkg
          pkgbuild \
            --root pkg-root \
            --identifier com.rapoyrazoglu.nihongo \
            --version "${VER}" \
            --scripts scripts \
            --install-location / \
            nihongo-component.pkg

          # Distribution XML (installer UI)
          cat > distribution.xml <<DIST
          <?xml version="1.0" encoding="utf-8"?>
          <installer-gui-script minSpecVersion="2">
            <title>Nihongo Master ${VER}</title>
            <welcome language="en" mime-type="text/html"><![CDATA[
              <html><body>
              <h2>Welcome to Nihongo Master</h2>
              <p>日本語マスターへようこそ！</p>
              <p>This will install Nihongo Master ${VER} on your Mac.</p>
              <p>A JLPT Japanese learning app with SRS flashcards, quizzes, and neural text-to-speech.</p>
              </body></html>
            ]]></welcome>
            <conclusion language="en" mime-type="text/html"><![CDATA[
              <html><body>
              <h2>Installation Complete!</h2>
              <p>Open Terminal and type <code>nihongo</code> to start.</p>
              <p>お疲れ様でした！</p>
              </body></html>
            ]]></conclusion>
            <options customize="never" require-scripts="false" hostArchitectures="x86_64,arm64"/>
            <choices-outline>
              <line choice="default"/>
            </choices-outline>
            <choice id="default" title="Nihongo Master">
              <pkg-ref id="com.rapoyrazoglu.nihongo"/>
            </choice>
            <pkg-ref id="com.rapoyrazoglu.nihongo" version="${VER}">nihongo-component.pkg</pkg-ref>
          </installer-gui-script>
          DIST

          # Final product pkg
          productbuild \
            --distribution distribution.xml \
            --package-path . \
            "nihongo-${VER}.pkg"

      - name: Upload PKG
        uses: actions/upload-artifact@v4
        with:
          name: nihongo-pkg
          path: nihongo-*.pkg

  release:
    needs: [build, windows-installer, macos-pkg]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Compute SHA256
        id: sha
        run: |
          echo "linux=$(sha256sum artifacts/nihongo-linux | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "macos=$(sha256sum artifacts/nihongo-macos | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      # --- Homebrew Formula guncelle ---
      - name: Update Homebrew formula
        run: |
          VER="${GITHUB_REF_NAME#v}"
          sed -i 's/version ".*"/version "'"$VER"'"/' Formula/nihongo.rb
          sed -i '0,/sha256 ".*"/{s/sha256 ".*"/sha256 "${{ steps.sha.outputs.macos }}"/}' Formula/nihongo.rb
          sed -i '0,/sha256 ".*"/! {0,/sha256 ".*"/ s/sha256 ".*"/sha256 "${{ steps.sha.outputs.linux }}"/}' Formula/nihongo.rb

      # --- PKGBUILD guncelle ---
      - name: Update PKGBUILD
        run: |
          VER="${GITHUB_REF_NAME#v}"
          sed -i "s/^pkgver=.*/pkgver=${VER}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/sha256sums=(.*/sha256sums=('${{ steps.sha.outputs.linux }}')/" PKGBUILD

      # --- .deb paketi ---
      - name: Build .deb
        run: |
          VER="${GITHUB_REF_NAME#v}"
          PKG="nihongo_${VER}_amd64"
          mkdir -p "${PKG}/DEBIAN" "${PKG}/usr/bin" "${PKG}/usr/share/applications" "${PKG}/usr/share/icons/hicolor/scalable/apps"
          cat > "${PKG}/DEBIAN/control" <<EOF
          Package: nihongo
          Version: ${VER}
          Section: education
          Priority: optional
          Architecture: amd64
          Depends: espeak-ng
          Maintainer: rapoyrazoglu
          Description: JLPT Japanese learning app
           Terminal-based SRS flashcard app for JLPT N5-N3.
           Features vocabulary, kanji, grammar study with spaced repetition.
          EOF
          sed -i 's/^          //' "${PKG}/DEBIAN/control"
          install -m755 artifacts/nihongo-linux "${PKG}/usr/bin/nihongo"
          cp nihongo.desktop "${PKG}/usr/share/applications/"
          cp assets/nihongo.svg "${PKG}/usr/share/icons/hicolor/scalable/apps/"
          dpkg-deb --build "${PKG}"
          mv "${PKG}.deb" artifacts/

      # --- APT repo ---
      - name: Build APT repo
        run: |
          mkdir -p apt-repo
          cp artifacts/*.deb apt-repo/
          cd apt-repo
          dpkg-scanpackages -m . > Packages
          gzip -k Packages

      # --- GitHub Release ---
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/nihongo-linux
            artifacts/nihongo-macos
            artifacts/nihongo-windows.exe
            artifacts/*.deb
            artifacts/nihongo-setup-*.exe
            artifacts/nihongo-*.pkg
          generate_release_notes: true
          body: |
            ## Installation

            **Windows:** Download `nihongo-setup-*.exe` and run the installer
            **macOS:** Download `.pkg` and run the installer
            **Ubuntu/Debian:** `sudo dpkg -i nihongo_*.deb`
            **Arch Linux:** `yay -S nihongo`
            **macOS (Homebrew):** `brew install rapoyrazoglu/nihongo/nihongo`

      # --- Commit formula + PKGBUILD ---
      - name: Push updated package files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/nihongo.rb PKGBUILD
          git diff --cached --quiet || git commit -m "chore: update packages for ${GITHUB_REF_NAME}"
          git push origin HEAD:main || true

      # --- AUR'a push ---
      - name: Publish to AUR
        if: ${{ !contains(github.ref_name, 'beta') && !contains(github.ref_name, 'alpha') }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key
          echo -e "Host aur.archlinux.org\n  IdentityFile ~/.ssh/aur_key\n  User aur\n  StrictHostKeyChecking no" > ~/.ssh/config

          VER="${GITHUB_REF_NAME#v}"

          git clone ssh://aur@aur.archlinux.org/nihongo.git aur-repo
          cp PKGBUILD aur-repo/PKGBUILD

          cd aur-repo
          cat > .SRCINFO <<SRCEOF
          pkgbase = nihongo
          	pkgdesc = JLPT Japanese learning app - SRS, quiz, kanji, grammar
          	pkgver = ${VER}
          	pkgrel = 1
          	url = https://github.com/rapoyrazoglu/nihongo
          	arch = x86_64
          	license = MIT
          	depends = espeak-ng
          	optdepends = fcitx5-mozc: Japanese input
          	source = nihongo-${VER}::https://github.com/rapoyrazoglu/nihongo/releases/download/v${VER}/nihongo-linux
          	sha256sums = ${{ steps.sha.outputs.linux }}

          pkgname = nihongo
          SRCEOF
          sed -i 's/^          //' .SRCINFO

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git diff --cached --quiet || git commit -m "Update to ${VER}"
          git push

      # --- APT repo -> gh-pages ---
      - name: Deploy APT repo to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt-repo
          publish_branch: gh-pages
