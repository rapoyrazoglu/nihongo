name: Build & Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pages: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact: nihongo-linux
            binary: dist/nihongo
          - os: macos-latest
            artifact: nihongo-macos
            binary: dist/nihongo
          - os: windows-latest
            artifact: nihongo-windows.exe
            binary: dist/nihongo.exe

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install rich>=13.0 pyinstaller

      - name: Build binary
        run: python -m PyInstaller nihongo.spec --clean --noconfirm

      - name: Test binary
        shell: bash
        continue-on-error: ${{ matrix.os == 'windows-latest' }}
        run: ./${{ matrix.binary }} --version

      - name: Rename artifact
        if: always()
        shell: bash
        run: cp "${{ matrix.binary }}" "${{ matrix.artifact }}"

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  release:
    needs: [build]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Compute SHA256
        id: sha
        run: |
          echo "linux=$(sha256sum artifacts/nihongo-linux | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "macos=$(sha256sum artifacts/nihongo-macos | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      # --- Homebrew Formula guncelle ---
      - name: Update Homebrew formula
        run: |
          VER="${GITHUB_REF_NAME#v}"
          sed -i 's/version ".*"/version "'"$VER"'"/' Formula/nihongo.rb
          sed -i '0,/sha256 ".*"/{s/sha256 ".*"/sha256 "${{ steps.sha.outputs.macos }}"/}' Formula/nihongo.rb
          sed -i '0,/sha256 ".*"/! {0,/sha256 ".*"/ s/sha256 ".*"/sha256 "${{ steps.sha.outputs.linux }}"/}' Formula/nihongo.rb

      # --- PKGBUILD guncelle ---
      - name: Update PKGBUILD
        run: |
          VER="${GITHUB_REF_NAME#v}"
          sed -i "s/^pkgver=.*/pkgver=${VER}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/sha256sums=(.*/sha256sums=('${{ steps.sha.outputs.linux }}')/" PKGBUILD

      # --- .deb paketi ---
      - name: Build .deb
        run: |
          VER="${GITHUB_REF_NAME#v}"
          PKG="nihongo_${VER}_amd64"
          mkdir -p "${PKG}/DEBIAN" "${PKG}/usr/bin" "${PKG}/usr/share/applications" "${PKG}/usr/share/icons/hicolor/scalable/apps"
          cat > "${PKG}/DEBIAN/control" <<EOF
          Package: nihongo
          Version: ${VER}
          Section: education
          Priority: optional
          Architecture: amd64
          Depends: espeak-ng
          Maintainer: rapoyrazoglu
          Description: JLPT Japanese learning app
           Terminal-based SRS flashcard app for JLPT N5-N3.
           Features vocabulary, kanji, grammar study with spaced repetition.
          EOF
          sed -i 's/^          //' "${PKG}/DEBIAN/control"
          install -m755 artifacts/nihongo-linux "${PKG}/usr/bin/nihongo"
          cp nihongo.desktop "${PKG}/usr/share/applications/"
          cp assets/nihongo.svg "${PKG}/usr/share/icons/hicolor/scalable/apps/"
          dpkg-deb --build "${PKG}"
          mv "${PKG}.deb" artifacts/

      # --- APT repo ---
      - name: Build APT repo
        run: |
          mkdir -p apt-repo
          cp artifacts/*.deb apt-repo/
          cd apt-repo
          dpkg-scanpackages -m . > Packages
          gzip -k Packages

      # --- GitHub Release ---
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/nihongo-linux
            artifacts/nihongo-macos
            artifacts/nihongo-windows.exe
            artifacts/*.deb
          generate_release_notes: true
          body: |
            ## Kurulum

            **Ubuntu/Debian:** `sudo dpkg -i nihongo_*.deb`
            **macOS:** `brew install rapoyrazoglu/nihongo/nihongo`
            **Arch:** `yay -S nihongo`
            **Windows:** [nihongo-windows.exe](https://github.com/rapoyrazoglu/nihongo/releases/latest) indir ve calistir

      # --- Commit formula + PKGBUILD ---
      - name: Push updated package files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/nihongo.rb PKGBUILD
          git diff --cached --quiet || git commit -m "chore: update packages for ${GITHUB_REF_NAME}"
          git push origin HEAD:main || true

      # --- AUR'a push ---
      - name: Publish to AUR
        if: ${{ !contains(github.ref_name, 'beta') && !contains(github.ref_name, 'alpha') }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > ~/.ssh/aur_key
          chmod 600 ~/.ssh/aur_key
          echo -e "Host aur.archlinux.org\n  IdentityFile ~/.ssh/aur_key\n  User aur\n  StrictHostKeyChecking no" > ~/.ssh/config

          VER="${GITHUB_REF_NAME#v}"

          git clone ssh://aur@aur.archlinux.org/nihongo.git aur-repo
          cp PKGBUILD aur-repo/PKGBUILD

          cd aur-repo
          # .SRCINFO Ã¼ret
          cat > .SRCINFO <<SRCEOF
          pkgbase = nihongo
          	pkgdesc = JLPT Japanese learning app - SRS, quiz, kanji, grammar
          	pkgver = ${VER}
          	pkgrel = 1
          	url = https://github.com/rapoyrazoglu/nihongo
          	arch = x86_64
          	license = MIT
          	depends = espeak-ng
          	optdepends = fcitx5-mozc: Japanese input
          	source = nihongo-${VER}::https://github.com/rapoyrazoglu/nihongo/releases/download/v${VER}/nihongo-linux
          	sha256sums = ${{ steps.sha.outputs.linux }}

          pkgname = nihongo
          SRCEOF
          sed -i 's/^          //' .SRCINFO

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add PKGBUILD .SRCINFO
          git diff --cached --quiet || git commit -m "Update to ${VER}"
          git push

      # --- APT repo -> gh-pages ---
      - name: Deploy APT repo to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt-repo
          publish_branch: gh-pages
